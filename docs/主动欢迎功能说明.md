# 🤖 Agent主动欢迎功能说明

## 📋 功能概述

当用户刚打开对话框但还没有说话时，Agent可以主动发送欢迎消息，引导用户开始对话。

---

## ✨ 为什么要使用主动欢迎？

### 问题场景
- 用户打开对话框，不知道该说什么
- 用户在犹豫，等待引导
- 用户不知道Agent能做什么

### 解决方案
- ✅ 主动介绍自己
- ✅ 说明能提供什么帮助
- ✅ 引导用户提供信息
- ✅ 降低用户决策门槛

---

## 🎯 实现方案

### 方案1：调用时检查（推荐）✨

在调用Agent之前，检查用户是否输入了消息：

```python
from agents.agent import build_agent, get_welcome_message
from langchain_core.messages import HumanMessage, AIMessage

async def chat_with_agent(user_input=None):
    agent = build_agent()

    # 如果用户没有输入（首次访问），自动发送欢迎语
    if not user_input or user_input.strip() == "":
        return {
            "message": get_welcome_message(),
            "is_welcome": True
        }

    # 否则正常调用Agent
    state = {"messages": [HumanMessage(content=user_input)]}
    result = await agent.ainvoke(state)

    return {
        "message": result['messages'][-1].content,
        "is_welcome": False
    }
```

### 方案2：使用包装函数

```python
from agents.agent import build_agent, agent_with_welcome_wrapper

# 创建带自动欢迎功能的Agent
agent = build_agent()
wrapped_agent = agent_with_welcome_wrapper(agent.ainvoke)

# 无论用户是否输入，都会自动处理
state = {"messages": []}  # 或 {"messages": [HumanMessage(content="你好")]}
result = await wrapped_agent(state)
```

### 方案3：前端处理（Web应用）

```javascript
// 前端示例
async function sendMessage(userInput) {
    if (!userInput || userInput.trim() === '') {
        // 用户还没说话，显示欢迎消息
        displayMessage(get_welcomeMessage());
        return;
    }

    // 用户输入了内容，正常调用Agent
    const response = await callAgent(userInput);
    displayMessage(response);
}
```

---

## 🔧 配置自定义欢迎语

### 方法1：通过环境变量（推荐）

编辑 `.env` 文件：

```bash
# 自定义欢迎消息
AGENT_WELCOME_MESSAGE=你好！我是你的创业指导助手，我可以帮你推荐创业项目、提供AI工具建议。请问有什么可以帮你的？
```

### 方法2：修改代码

编辑 `src/agents/agent.py`：

```python
# 修改 WELCOME_MESSAGE 变量
WELCOME_MESSAGE = """
你的自定义欢迎语...
"""
```

---

## 📊 效果对比

### ❌ 没有主动欢迎

```
用户：（打开对话框）
（空白，什么都没有）
用户：（不知道该说什么，关闭页面）
```

### ✅ 有主动欢迎

```
用户：（打开对话框）

Agent：你好！我是OPC超级个体孵化助手。我们深度研究了100个超级个体成功案例，并针对全国主要城市的市场环境进行了充分调研。基于这些数据和经验，我可以为你推荐最适合的创业方向，并提供资源对接孵化群的持续支持。

为了给你精准匹配创业项目，请告诉我以下信息：

1. 你的常住地址或计划创业的城市是哪里？
2. 你拥有哪些专业技能？比如编程、设计、写作、营销、摄影等？
3. 能简单介绍一下你的工作经验吗？包括所在行业、职位和工作年限？
4. 你的个人兴趣和爱好是什么？比如是否喜欢内容创作、手工制作、社交活动等？

💡 你也可以直接告诉我你想了解的内容，比如：
- "我想做XX类型的创业"
- "帮我推荐适合我的创业项目"
- "我想了解AI工具推荐"

期待你的回复！

用户：哦，我想做内容创业
Agent：好的，请问你想在哪个城市创业？
用户：杭州
Agent：（继续对话...）
```

---

## 🌐 在Web应用中集成

### FastAPI 示例

```python
from fastapi import FastAPI, Request, HTTPException
from fastapi.responses import JSONResponse
from agents.agent import build_agent, get_welcome_message
from langchain_core.messages import HumanMessage

app = FastAPI()
agent = build_agent()

@app.post("/chat")
async def chat_endpoint(request: Request):
    """聊天接口，支持自动欢迎"""
    try:
        data = await request.json()
        user_input = data.get("message", "")

        # 如果没有输入，返回欢迎消息
        if not user_input or user_input.strip() == "":
            return JSONResponse({
                "message": get_welcome_message(),
                "is_welcome": True,
                "timestamp": int(time.time())
            })

        # 否则正常处理
        state = {"messages": [HumanMessage(content=user_input)]}
        result = await agent.ainvoke(state)

        return JSONResponse({
            "message": result['messages'][-1].content,
            "is_welcome": False,
            "timestamp": int(time.time())
        })

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

### 前端集成示例

```javascript
// React 示例
import React, { useState, useEffect } from 'react';

function ChatComponent() {
    const [messages, setMessages] = useState([]);
    const [inputValue, setInputValue] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    // 组件加载时，自动显示欢迎消息
    useEffect(() => {
        if (messages.length === 0) {
            sendMessage('');
        }
    }, []);

    const sendMessage = async (userInput = inputValue) => {
        setIsLoading(true);

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: userInput })
            });

            const data = await response.json();

            setMessages([...messages, {
                role: data.is_welcome ? 'assistant' : 'assistant',
                content: data.message
            }]);

            setInputValue('');
        } catch (error) {
            console.error('Error:', error);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="chat-container">
            {messages.map((msg, index) => (
                <div key={index} className={`message ${msg.role}`}>
                    {msg.content}
                </div>
            ))}
            <input
                value={inputValue}
                onChange={(e) => setInputValue(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                placeholder="输入你的问题..."
            />
            <button onClick={() => sendMessage()} disabled={isLoading}>
                {isLoading ? '发送中...' : '发送'}
            </button>
        </div>
    );
}
```

---

## 🎯 触发时机

### ✅ 会触发自动欢迎

- 用户刚打开对话框，还没说话
- 消息列表为空 `[]`
- 用户清除了对话历史后重新打开
- 用户点击"新对话"按钮

### ❌ 不会触发自动欢迎

- 用户已经发送过消息
- 消息列表中包含用户的输入
- 对话进行中
- 用户主动发送空消息但已有对话历史

---

## 📝 默认欢迎语内容

```markdown
你好！我是OPC超级个体孵化助手。我们深度研究了100个超级个体成功案例，并针对全国主要城市的市场环境进行了充分调研。基于这些数据和经验，我可以为你推荐最适合的创业方向，并提供资源对接孵化群的持续支持。

为了给你精准匹配创业项目，请告诉我以下信息：

1. 你的常住地址或计划创业的城市是哪里？
2. 你拥有哪些专业技能？比如编程、设计、写作、营销、摄影等？
3. 能简单介绍一下你的工作经验吗？包括所在行业、职位和工作年限？
4. 你的个人兴趣和爱好是什么？比如是否喜欢内容创作、手工制作、社交活动等？

💡 你也可以直接告诉我你想了解的内容，比如：
- "我想做XX类型的创业"
- "帮我推荐适合我的创业项目"
- "我想了解AI工具推荐"

期待你的回复！
```

---

## 🧪 测试

运行测试脚本：

```bash
python tests/test_auto_welcome.py
```

预期输出：

```
============================================================
测试1：自动欢迎功能
============================================================

【场景1】消息为空（用户还没说话）
✓ 自动欢迎消息已发送
内容预览（前100字）：你好！我是OPC超级个体孵化助手...

============================================================
✅ 测试通过！
```

---

## 💡 最佳实践

### 1. 欢迎语应该包含

- ✅ 自我介绍（我是谁）
- ✅ 服务说明（我能做什么）
- ✅ 引导问题（请告诉我...）
- ✅ 使用提示（你也可以直接说...）
- ✅ 鼓励语（期待你的回复）

### 2. 欢迎语应该避免

- ❌ 过于冗长（不超过200字）
- ❌ 过于技术化（使用通俗易懂的语言）
- ❌ 过于生硬（要有温度和亲和力）
- ❌ 没有引导（不知道下一步该做什么）

### 3. 欢迎语的设计原则

- **简洁明了**：3-5行文字即可
- **引导性强**：明确告诉用户下一步该做什么
- **有亲和力**：使用友好、热情的语气
- **个性化**：根据业务场景定制

---

## 📊 数据统计建议

使用主动欢迎后，建议统计以下指标：

- 欢迎消息展示次数
- 用户在看到欢迎消息后的响应率
- 首次响应时间
- 对话转化率（从欢迎到完成支付）

这些数据可以帮助你优化欢迎语内容。

---

## 🚀 快速开始

### 步骤1：配置欢迎语（可选）

编辑 `.env` 文件：

```bash
AGENT_WELCOME_MESSAGE=你的自定义欢迎语
```

### 步骤2：在调用时检查

```python
from agents.agent import get_welcome_message

# 检查用户是否输入
if not user_input:
    return get_welcome_message()
```

### 步骤3：测试

```bash
python tests/test_auto_welcome.py
```

### 步骤4：部署

集成到你的Web应用中，让Agent在用户打开对话框时自动发送欢迎消息。

---

## 📞 需要帮助？

如果在使用过程中遇到问题，请：
1. 查看本文档
2. 查看测试代码：`tests/test_auto_welcome.py`
3. 查看Agent代码：`src/agents/agent.py`

---

**祝你使用愉快！** 🎉
