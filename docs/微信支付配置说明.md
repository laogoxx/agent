# 微信支付配置说明

## 快速开始

### 1. 安装依赖

```bash
pip install wechatpayv3 qrcode
```

### 2. 配置方式（二选一）

#### 方式一：使用配置文件（推荐）

1. 复制配置模板：
```bash
cp config/payment_config.json.example config/payment_config.json
```

2. 编辑 `config/payment_config.json`，填入你的微信支付凭证：
```json
{
    "wechat_pay": {
        "mchid": "1234567890",  // 替换为你的商户号
        "appid": "wxd678efh567hg6787",  // 替换为你的应用ID
        "apiv3_key": "MIIEvwIBADANBgkqhkiG9w0BAQEFAA...",  // 替换为你的APIv3密钥
        "cert_serial_no": "444F4864EA9B34415...",  // 替换为你的证书序列号
        "private_key_path": "config/certs/apiclient_key.pem",
        "cert_dir": "config/certs",
        "notify_url": "https://your-domain.com/api/pay/notify"  // 替换为你的回调地址
    }
}
```

#### 方式二：使用环境变量

1. 复制环境变量模板：
```bash
cp .env.example .env
```

2. 编辑 `.env` 文件，填入你的微信支付凭证：
```bash
WECHAT_PAY_MCHID=1234567890
WECHAT_PAY_APPID=wxd678efh567hg6787
WECHAT_PAY_APIV3_KEY=MIIEvwIBADANBgkqhkiG9w0BAQEFAA...
WECHAT_PAY_CERT_SERIAL_NO=444F4864EA9B34415...
WECHAT_PAY_PRIVATE_KEY_PATH=config/certs/apiclient_key.pem
WECHAT_PAY_CERT_DIR=config/certs
WECHAT_PAY_NOTIFY_URL=https://your-domain.com/api/pay/notify
```

### 3. 放置证书文件

1. 创建证书目录：
```bash
mkdir -p config/certs
```

2. 将以下文件放置到 `config/certs/` 目录：
- `apiclient_key.pem`（商户私钥）
- `apiclient_cert.pem`（商户证书）
- `apiclient_cert.p12`（PKCS12格式证书）

3. 设置文件权限（Linux/Mac）：
```bash
chmod 600 config/certs/*.pem
chmod 600 config/certs/*.p12
```

**⚠️ 重要提醒**：
- 证书文件绝不能上传到Git仓库
- 建议将 `config/certs/` 添加到 `.gitignore`

### 4. 验证配置

创建测试脚本 `test_wechat_pay.py`：

```python
from tools.wechat_pay import load_payment_config, get_wechatpay_client

# 测试配置加载
config = load_payment_config()
print("✅ 配置加载成功：")
print(f"  商户号: {config.get('mchid')}")
print(f"  应用ID: {config.get('appid')}")
print(f"  证书序列号: {config.get('cert_serial_no')}")

# 测试客户端初始化
try:
    client = get_wechatpay_client()
    print("\n✅ 微信支付客户端初始化成功")
except Exception as e:
    print(f"\n❌ 客户端初始化失败: {e}")
```

运行测试：
```bash
python test_wechat_pay.py
```

## 配置参数说明

| 参数 | 说明 | 必填 | 示例 |
|------|------|------|------|
| mchid | 微信支付商户号 | 是 | 1234567890 |
| appid | 微信应用ID | 否（Native支付可不填） | wxd678efh567hg6787 |
| apiv3_key | APIv3密钥（32位） | 是 | MIIEvwIBADANBgkqhkiG9w0BAQEFAA... |
| cert_serial_no | 证书序列号 | 是 | 444F4864EA9B34415... |
| private_key_path | 商户私钥文件路径 | 是 | config/certs/apiclient_key.pem |
| cert_dir | 平台证书缓存目录 | 否 | config/certs |
| notify_url | 支付结果回调地址 | 否 | https://your-domain.com/api/pay/notify |

## 获取配置信息

### 1. 获取商户号（mchid）
- 登录微信支付商户平台
- 进入「账户中心」→「商户信息」
- 查看商户号

### 2. 获取应用ID（appid）
- 登录微信支付商户平台
- 进入「产品中心」→「开发配置」
- 点击「关联公众号/App」
- 查看应用ID

### 3. 获取APIv3密钥（apiv3_key）
- 登录微信支付商户平台
- 进入「账户中心」→「API 安全」
- 点击「设置 API v3 密钥」
- 生成并保存32位密钥

### 4. 获取证书序列号（cert_serial_no）
#### 方法一：从商户平台获取
1. 登录微信支付商户平台
2. 进入「账户中心」→「API 安全」→「API证书」
3. 查看证书序列号

#### 方法二：使用OpenSSL命令
```bash
openssl x509 -in config/certs/apiclient_cert.pem -noout -serial
```

### 5. 获取商户私钥文件（apiclient_key.pem）
- 登录微信支付商户平台
- 进入「账户中心」→「API 安全」→「API证书」
- 下载证书文件
- 解压后找到 `apiclient_key.pem`

## 测试支付

### 1. 创建测试订单

```python
from tools.wechat_pay import create_wechat_pay_order
import time

# 生成唯一订单号
order_no = f"TEST{int(time.time())}"

# 创建订单（金额0.01元）
result = create_wechat_pay_order(
    out_trade_no=order_no,
    total=1,
    description="测试商品"
)

print(result)
```

### 2. 查询订单状态

```python
from tools.wechat_pay import query_wechat_pay_order

# 查询订单
result = query_wechat_pay_order(order_no)
print(result)
```

### 3. 使用沙箱环境测试

在商户平台中：
1. 进入「开发配置」
2. 启用「沙箱环境」
3. 获取沙箱商户号和API密钥
4. 使用沙箱凭证进行测试

## 常见配置错误

### 错误1：商户私钥文件不存在
```
FileNotFoundError: 商户私钥文件不存在: config/certs/apiclient_key.pem
```
**解决方法**：
- 确认证书文件已放置到正确路径
- 检查文件名是否正确（大小写敏感）
- 确认路径是相对路径或绝对路径

### 错误2：配置不完整
```
ValueError: 微信支付配置不完整，缺少必要字段: mchid, apiv3_key
```
**解决方法**：
- 检查配置文件是否包含所有必填字段
- 确认字段名拼写正确
- 重新保存配置文件

### 错误3：证书序列号错误
```
RuntimeError: 初始化微信支付客户端失败: 证书序列号不匹配
```
**解决方法**：
- 确认证书序列号正确
- 使用OpenSSL命令验证证书序列号
- 确认使用的是正确的商户证书

### 错误4：APIv3密钥错误
```
RuntimeError: 初始化微信支付客户端失败: 签名验证失败
```
**解决方法**：
- 确认APIv3密钥正确（32位大小写字母+数字）
- 确认没有多余的空格或换行符
- 重新生成APIv3密钥

## 安全建议

### 1. 敏感信息保护
- ⚠️ 不要将密钥和证书上传到Git仓库
- ⚠️ 使用环境变量管理敏感信息
- ⚠️ 定期更换APIv3密钥

### 2. 文件权限设置
```bash
# 设置证书文件权限
chmod 600 config/certs/*.pem
chmod 600 config/certs/*.p12

# 设置配置文件权限
chmod 600 config/payment_config.json
chmod 600 .env
```

### 3. Git忽略配置
在 `.gitignore` 中添加：
```
# 证书文件
config/certs/*.pem
config/certs/*.p12

# 配置文件
config/payment_config.json
.env

# 测试文件
test_wechat_pay.py
```

### 4. 日志管理
- 不要在日志中记录敏感信息（密钥、证书）
- 记录支付相关的操作日志（订单号、金额、状态）
- 定期清理过期日志

## 生产环境配置

### 1. 使用环境变量
生产环境建议使用环境变量管理敏感信息：

```bash
# 设置环境变量
export WECHAT_PAY_MCHID=1234567890
export WECHAT_PAY_APIV3_KEY=MIIEvwIBADANBgkqhkiG9w0BAQEFAA...
export WECHAT_PAY_CERT_SERIAL_NO=444F4864EA9B34415...
```

### 2. 配置HTTPS回调
- 回调地址必须是HTTPS
- 使用有效的SSL证书
- 配置防火墙开放443端口

### 3. 配置代理（如需要）
在配置中添加代理设置：
```python
wxpay = WeChatPay(
    ...
    proxy={"https": "http://your-proxy:8080"}
)
```

## 下一步

1. ✅ 完成配置
2. ✅ 运行测试脚本验证配置
3. ✅ 在沙箱环境测试支付
4. ✅ 切换到生产环境
5. ✅ 监控支付日志和异常

## 技术支持

- 微信支付官方文档：https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml
- wechatpayv3 SDK：https://github.com/wechatpay-apiv3/wechatpay-python
- 商户平台：https://pay.weixin.qq.com
- 配置指南：docs/微信支付接入指南.md

---

**配置完成后，请运行测试脚本验证配置是否正确！**
